<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulateur 3D Robots + Blockly</title>
<style>
  body{margin:0;background:#111;color:#fff;font-family:Arial}
  h2{margin:0;padding:10px;background:#222;color:#0af;border-bottom:2px solid #0af}
  #toolbar{padding:10px;background:#000;border-bottom:1px solid #333}
  #toolbar button{padding:8px 14px;margin-right:6px;background:#0af;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #toolbar button:hover{background:#08c}
  #sim_container{width:100%;height:600px;position:relative;background:#000}
  canvas{background:#000;display:block;margin:auto}
  #blocklyDiv{height:400px;width:100%;border:1px solid #444;margin-top:10px;}
  #runBlocks{padding:8px 16px;margin-top:6px;background:#0af;color:#fff;border:none;border-radius:4px;cursor:pointer;}
</style>
</head>

<body>
<h2>Simulateur 3D — Robots B & C + Blockly</h2>

<div id="toolbar">
  <button onclick="addRobotB()">➕ Ajouter Robot B (Wall-E)</button>
  <button onclick="addRobotC()">➕ Ajouter Robot C (Futuriste)</button>
  <button onclick="resetSim()">♻ Réinitialiser</button>
</div>

<div id="sim_container"></div>

<!-- Blockly -->
<div id="blocklyDiv"></div>
<button id="runBlocks">▶ Play</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>

<script>
// ------------------ SIMULATEUR 3D ------------------
let scene, camera, renderer, robots=[];
const container = document.getElementById('sim_container');

function startSim(){
  const W = container.clientWidth||800, H=container.clientHeight||600;
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60,W/H,0.1,1000);
  camera.position.set(6,4,6); camera.lookAt(0,0,0);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(W,H);
  container.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff,1.2); light.position.set(5,10,5); scene.add(light);
  scene.add(new THREE.AmbientLight(0x666666,0.6));

  const floor = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({color:0x303030}));
  floor.rotation.x = -Math.PI/2; scene.add(floor);

  animate();
}

function addRobotB(){
  const geo = new THREE.BoxGeometry(1,1,1);
  const mat = new THREE.MeshStandardMaterial({color:0xffdd66});
  const mesh = new THREE.Mesh(geo,mat); mesh.position.set(0,0.5,0); scene.add(mesh);
  robots.push({mesh});
}

function addRobotC(){
  const geo = new THREE.ConeGeometry(0.5,1,4);
  const mat = new THREE.MeshStandardMaterial({color:0x66aaff});
  const mesh = new THREE.Mesh(geo,mat); mesh.position.set(2,0.5,0); scene.add(mesh);
  robots.push({mesh});
}

function resetSim(){
  robots.forEach(r=>{
    if(r.mesh) scene.remove(r.mesh);
  });
  robots=[]; 
}

function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}

// API Blockly
window.robot_api = {
  move: function(id,dist){
    if(!robots[id]||!robots[id].mesh) return;
    const mesh = robots[id].mesh;
    const angle = mesh.rotation.y;
    mesh.position.x += Math.sin(angle) * dist * 0.01;
    mesh.position.z += Math.cos(angle) * dist * 0.01;
  },
  turn: function(id,deg){
    if(!robots[id]||!robots[id].mesh) return;
    const mesh = robots[id].mesh;
    mesh.rotation.y += deg * Math.PI/180;
  }
};

startSim();

// ------------------ BLOCKLY ------------------
const workspace = Blockly.inject('blocklyDiv',{
  toolbox: `
    <xml xmlns="https://developers.google.com/blockly/xml">
      <block type="move_forward"></block>
      <block type="turn"></block>
    </xml>
  `
});

// Définition des blocs
Blockly.Blocks['move_forward'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Avancer de")
        .appendField(new Blockly.FieldNumber(50, 1, 500), "DIST")
        .appendField("px");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(120);
  }
};
Blockly.JavaScript['move_forward'] = function(block) {
  const dist = Number(block.getFieldValue('DIST'));
  return `
    robot_api.move(0, ${dist});
  `;
};

Blockly.Blocks['turn'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Tourner de")
        .appendField(new Blockly.FieldAngle(90), "ANGLE")
        .appendField("°");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(230);
  }
};
Blockly.JavaScript['turn'] = function(block) {
  const deg = Number(block.getFieldValue('ANGLE'));
  return `
    robot_api.turn(0, ${deg});
  `;
};

// Bouton Play
document.getElementById('runBlocks').addEventListener('click', ()=>{
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  try{
    const AsyncFn = Object.getPrototypeOf(async function(){}).constructor;
    const fn = new AsyncFn(code);
    fn();
  }catch(e){ console.error("Erreur Blockly:", e);}
});
</script>
</body>
</html>