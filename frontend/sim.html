<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulateur 3D Robots — B & C</title>

<style>
  body{margin:0;background:#111;color:#fff;font-family:Arial}
  h2{margin:0;padding:10px;background:#222;color:#0af;border-bottom:2px solid #0af}
  #toolbar{padding:10px;background:#000;border-bottom:1px solid #333}
  #toolbar button{padding:8px 14px;margin-right:6px;background:#0af;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #toolbar button:hover{background:#08c}
  #sim_container{width:100%;height:600px;position:relative;background:#000}
  canvas{background:#000;display:block;margin:auto}
</style>
</head>

<body>
<h2>Simulateur 3D — Robots B & C</h2>

<div id="toolbar">
  <button onclick="addRobotB()">➕ Ajouter Robot B (Wall-E)</button>
  <button onclick="addRobotC()">➕ Ajouter Robot C (Futuriste)</button>
  <button onclick="resetSim()">♻ Réinitialiser</button>
</div>

<div id="sim_container">
  <canvas id="sim" width="800" height="600"></canvas>
</div>

<script>
/* -------------------------
   SIMULATEUR SANS THREE/PHYSIQUE
   (Compatible téléphones, Render etc.)
------------------------- */

const canvas = document.getElementById('sim');
const ctx = canvas.getContext('2d');

let robots = [];
let lastTime = 0;

/* --------- ROBOT B (Wall-E simplifié) --------- */
function createRobotB(){
  return {
    type:"B",
    x: Math.random()*500+100,
    y: Math.random()*300+150,
    angle: 0,
    size: 40,
    color:"#ffdd66",
    wheelsColor:"#444",
    eyeColor:"#fff"
  };
}

/* --------- ROBOT C (Futuriste angulaire) --------- */
function createRobotC(){
  return {
    type:"C",
    x: Math.random()*500+100,
    y: Math.random()*300+150,
    angle: 0,
    size: 45,
    color:"#66aaff",
    neon:"#0ff"
  };
}

/* --------- AJOUT AU SIMULATEUR --------- */
function addRobotB(){
  robots.push(createRobotB());
}
function addRobotC(){
  robots.push(createRobotC());
}

function resetSim(){
  robots = [];
}

/* --------- API POUR BLOCKLY --------- */
window.robot_api = {
  move: function(id, dist){
    const r = robots[id];
    if(!r) return;

    r.x += Math.cos(r.angle) * dist;
    r.y += Math.sin(r.angle) * dist;
  },
  turn: function(id, deg){
    const r = robots[id];
    if(!r) return;
    r.angle += deg * Math.PI/180;
  }
};

/* --------- DESSIN DU ROBOT B --------- */
function drawRobotB(r){
  ctx.save();
  ctx.translate(r.x, r.y);
  ctx.rotate(r.angle);

  // corps
  ctx.fillStyle = r.color;
  ctx.fillRect(-r.size/2, -r.size/2, r.size, r.size);

  // tête
  ctx.fillStyle = r.color;
  ctx.fillRect(-r.size/3, -r.size*0.9, r.size*0.66, r.size*0.5);

  // yeux
  ctx.fillStyle = r.eyeColor;
  ctx.beginPath();
  ctx.arc(-10, -r.size*0.7, 6, 0, Math.PI*2);
  ctx.arc( 10, -r.size*0.7, 6, 0, Math.PI*2);
  ctx.fill();

  // roues
  ctx.fillStyle = r.wheelsColor;
  ctx.fillRect(-r.size/2-6, -r.size/3, 6, r.size*0.66);
  ctx.fillRect( r.size/2 , -r.size/3, 6, r.size*0.66);

  ctx.restore();
}

/* --------- DESSIN DU ROBOT C --------- */
function drawRobotC(r){
  ctx.save();
  ctx.translate(r.x, r.y);
  ctx.rotate(r.angle);

  // forme principale triangulaire
  ctx.fillStyle = r.color;
  ctx.beginPath();
  ctx.moveTo(0, -r.size/1.2);
  ctx.lineTo(-r.size/1.3, r.size/1.2);
  ctx.lineTo(r.size/1.3, r.size/1.2);
  ctx.closePath();
  ctx.fill();

  // LED
  ctx.fillStyle = r.neon;
  ctx.fillRect(-8, -r.size*0.2, 16, 6);

  ctx.restore();
}

/* --------- RENDER LOOP --------- */
function loop(timestamp){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  robots.forEach((r, i)=>{
    if(r.type === "B") drawRobotB(r);
    if(r.type === "C") drawRobotC(r);
  });

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* --------- RÉCEPTION DES BLOCS --------- */
window.addEventListener("message", ev=>{
  if(ev.data && ev.data.type === "run_code"){
    try{
      const AsyncFn = Object.getPrototypeOf(async function(){}).constructor;
      const fn = new AsyncFn("robot_api", ev.data.code);
      fn(window.robot_api);
    }catch(e){
      console.error(e);
    }
  }
});
</script>
</body>
</html>