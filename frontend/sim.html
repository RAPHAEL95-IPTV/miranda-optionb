<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulateur 3D Robots — B & C</title>

<style>
  body{margin:0;background:#111;color:#fff;font-family:Arial}
  h2{margin:0;padding:10px;background:#222;color:#0af;border-bottom:2px solid #0af}
  #toolbar{padding:10px;background:#000;border-bottom:1px solid #333}
  #toolbar button{padding:8px 14px;margin-right:6px;background:#0af;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #toolbar button:hover{background:#08c}
  #sim_container{width:100%;height:600px;position:relative;background:#000}
  canvas{background:#000;display:block;margin:auto}
</style>
</head>

<body>
<h2>Simulateur 3D — Robots B & C</h2>

<div id="toolbar">
  <button onclick="addRobotB()">➕ Ajouter Robot B (Wall-E)</button>
  <button onclick="addRobotC()">➕ Ajouter Robot C (Futuriste)</button>
  <button onclick="resetSim()">♻ Réinitialiser</button>
</div>

<div id="sim_container">
  <canvas id="sim" width="800" height="600"></canvas>
</div>

<script>
/* ------------------------------------------------------------
   SIMULATEUR 2D + NAVIGATION TYPE BLENDER (PAN / ZOOM / ORBIT)
   ------------------------------------------------------------ */

const canvas = document.getElementById("sim");
const ctx = canvas.getContext("2d");

// caméra
let camX = 0;       // déplacement horizontal
let camY = 0;       // déplacement vertical
let camZoom = 1;    // zoom
let camRot = 0;     // rotation globale (vue orbitale)

let isRightDragging = false;
let isLeftDragging = false;
let lastMouseX = 0;
let lastMouseY = 0;

// robots
let robots = [];

/* --------------------------
   CREATION DES ROBOTS
--------------------------- */
function createRobotB(){
  return {
    type:"B",
    x: Math.random()*500+100,
    y: Math.random()*300+150,
    angle: 0,
    size: 40,
    color:"#ffdd66",
    wheelsColor:"#444",
    eyeColor:"#fff"
  };
}

function createRobotC(){
  return {
    type:"C",
    x: Math.random()*500+100,
    y: Math.random()*300+150,
    angle: 0,
    size: 45,
    color:"#66aaff",
    neon:"#0ff"
  };
}

function addRobotB(){ robots.push(createRobotB()); }
function addRobotC(){ robots.push(createRobotC()); }
function resetSim(){ robots = []; }

/* --------------------------
   API BLOCKLY
--------------------------- */
window.robot_api = {
  move: function(id, dist){
    const r = robots[id];
    if(!r) return;

    r.x += Math.cos(r.angle) * dist;
    r.y += Math.sin(r.angle) * dist;
  },
  turn: function(id, deg){
    const r = robots[id];
    if(!r) return;
    r.angle += deg * Math.PI/180;
  }
};

/* --------------------------
   DESSIN DES ROBOTS
--------------------------- */
function drawRobotB(r){
  ctx.save();
  ctx.translate(r.x, r.y);
  ctx.rotate(r.angle);

  ctx.fillStyle = r.color;
  ctx.fillRect(-r.size/2, -r.size/2, r.size, r.size);

  ctx.fillRect(-r.size/3, -r.size*0.9, r.size*0.66, r.size*0.5);

  ctx.fillStyle = r.eyeColor;
  ctx.beginPath();
  ctx.arc(-10, -r.size*0.7, 6, 0, Math.PI*2);
  ctx.arc(10, -r.size*0.7, 6, 0, Math.PI*2);
  ctx.fill();

  ctx.fillStyle = r.wheelsColor;
  ctx.fillRect(-r.size/2-6, -r.size/3, 6, r.size*0.66);
  ctx.fillRect(r.size/2, -r.size/3, 6, r.size*0.66);

  ctx.restore();
}

function drawRobotC(r){
  ctx.save();
  ctx.translate(r.x, r.y);
  ctx.rotate(r.angle);

  ctx.fillStyle = r.color;
  ctx.beginPath();
  ctx.moveTo(0, -r.size/1.2);
  ctx.lineTo(-r.size/1.3, r.size/1.2);
  ctx.lineTo(r.size/1.3, r.size/1.2);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = r.neon;
  ctx.fillRect(-8, -r.size*0.2, 16, 6);

  ctx.restore();
}

/* --------------------------
   NAVIGATION STYLE BLENDER
--------------------------- */
canvas.addEventListener("contextmenu", e => e.preventDefault());

canvas.addEventListener("mousedown", e => {
  if(e.button === 2){ isRightDragging = true; }
  if(e.button === 0){ isLeftDragging = true; }
  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
});

canvas.addEventListener("mouseup", e => {
  if(e.button === 2) isRightDragging = false;
  if(e.button === 0) isLeftDragging = false;
});

canvas.addEventListener("mousemove", e => {
  const dx = e.clientX - lastMouseX;
  const dy = e.clientY - lastMouseY;

  if(isRightDragging){
    camX += dx / camZoom;
    camY += dy / camZoom;
  }

  if(isLeftDragging){
    camRot += dx * 0.01; // rotation orbitale
  }

  lastMouseX = e.clientX;
  lastMouseY = e.clientY;
});

canvas.addEventListener("wheel", e => {
  const zoomFactor = 1.1;
  if(e.deltaY < 0) camZoom *= zoomFactor;
  else camZoom /= zoomFactor;
});

/* --------------------------
   RENDER LOOP
--------------------------- */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();

  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.scale(camZoom, camZoom);
  ctx.rotate(camRot);
  ctx.translate(-canvas.width/2 + camX, -canvas.height/2 + camY);

  robots.forEach(r=>{
    if(r.type==="B") drawRobotB(r);
    if(r.type==="C") drawRobotC(r);
  });

  ctx.restore();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* --------------------------
   Réception du code Blockly
--------------------------- */
window.addEventListener("message", ev => {
  if(ev.data && ev.data.type === "run_code"){
    try{
      const AsyncFn = Object.getPrototypeOf(async function(){}).constructor;
      const fn = new AsyncFn("robot_api", ev.data.code);
      fn(window.robot_api);
    }catch(e){
      console.error(e);
    }
  }
});
</script>

<!-- ----------------------------------------------------------
     AJOUT BLOCS Blockly + BOUTON PLAY (NE MODIFIE RIEN DU CODE EXISTANT)
----------------------------------------------------------- -->

<!-- Div Blockly -->
<div id="blocklyDiv" style="height: 400px; width: 400px; float:left; border:1px solid #333; margin:10px"></div>

<!-- Bouton Play -->
<div style="padding:10px; float:left;">
  <button onclick="runBlockly()" style="padding:10px 16px; background:#0af; color:#fff; border:none; border-radius:4px; cursor:pointer;">▶ Play Blockly</button>
</div>

<!-- Blockly libs -->
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/blockly/media/blockly.css">

<script>
// Initialisation Blockly
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: `
    <xml>
      <block type="move_forward"></block>
      <block type="turn_right"></block>
      <block type="turn_left"></block>
    </xml>
  `,
  trashcan: true
});

// Définition blocs
Blockly.defineBlocksWithJsonArray([
  {
    "type": "move_forward",
    "message0": "Avancer de %1 pixels",
    "args0": [{"type": "field_number", "name": "DIST", "value": 10}],
    "previousStatement": null,
    "nextStatement": null,
    "colour": 120
  },
  {
    "type": "turn_right",
    "message0": "Tourner à droite de %1 degrés",
    "args0": [{"type": "field_number", "name": "ANGLE", "value": 90}],
    "previousStatement": null,
    "nextStatement": null,
    "colour": 160
  },
  {
    "type": "turn_left",
    "message0": "Tourner à gauche de %1 degrés",
    "args0": [{"type": "field_number", "name": "ANGLE", "value": 90}],
    "previousStatement": null,
    "nextStatement": null,
    "colour": 160
  }
]);

// Génération JS depuis Blockly
Blockly.JavaScript['move_forward'] = function(block) {
  var value = block.getFieldValue('DIST');
  return `robot_api.move(selectedRobotId, ${value});\n`;
};
Blockly.JavaScript['turn_right'] = function(block) {
  var value = block.getFieldValue('ANGLE');
  return `robot_api.turn(selectedRobotId, ${value});\n`;
};
Blockly.JavaScript['turn_left'] = function(block) {
  var value = block.getFieldValue('ANGLE');
  return `robot_api.turn(selectedRobotId, -${value});\n`;
};

// Exécution Blockly
function runBlockly(){
  if(typeof robots === 'undefined' || robots.length === 0){
    alert("Ajoutez d'abord un robot !");
    return;
  }
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  try{
    const AsyncFn = Object.getPrototypeOf(async function(){}).constructor;
    const fn = new AsyncFn("robot_api", "selectedRobotId", code);
    const selectedRobotId = robots.length-1;
    fn(window.robot_api, selectedRobotId);
  } catch(e){
    console.error(e);
  }
}
</script>
</body>
</html>