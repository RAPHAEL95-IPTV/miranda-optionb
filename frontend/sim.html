<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulateur 2D Robots — Blockly</title>

<style>
  body{margin:0;background:#111;color:#fff;font-family:Arial}
  h2{margin:0;padding:10px;background:#222;color:#0af;border-bottom:2px solid #0af}
  #toolbar{padding:10px;background:#000;border-bottom:1px solid #333}
  #toolbar button{padding:8px 14px;margin-right:6px;background:#0af;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #toolbar button:hover{background:#08c}
  #sim_container{width:100%;height:500px;position:relative;background:#000}
  canvas{background:#000;display:block;margin:auto}
  #blocklyDiv{height:300px;width:100%;background:#222;border-top:2px solid #0af;}
  #runBtn{margin:10px;padding:10px 20px;background:#0af;border:none;color:#fff;cursor:pointer;border-radius:5px;}
</style>
</head>

<body>
<h2>Simulateur 2D + Programmation Blockly</h2>

<div id="toolbar">
  <button onclick="addRobotB()">➕ Ajouter Robot B</button>
  <button onclick="addRobotC()">➕ Ajouter Robot C</button>
  <button onclick="resetSim()">♻ Réinitialiser</button>
</div>

<div id="sim_container">
  <canvas id="sim" width="800" height="500"></canvas>
</div>

<div id="blocklyDiv"></div>
<button id="runBtn">▶ Exécuter</button>

<script src="https://unpkg.com/blockly/blockly.min.js"></script>

<script>
// =======================
//  SIMULATEUR 2D ORIGINAL
// =======================

const canvas = document.getElementById("sim");
const ctx = canvas.getContext("2d");

let robots = [];

// --- Création robots ---
function createRobotB(){
  return {
    type:"B",
    x:100 + Math.random()*500,
    y:100 + Math.random()*300,
    angle:0,
    size:40,
    color:"#ffdd66"
  };
}

function createRobotC(){
  return {
    type:"C",
    x:100 + Math.random()*500,
    y:100 + Math.random()*300,
    angle:0,
    size:40,
    color:"#66aaff"
  };
}

function addRobotB(){ robots.push(createRobotB()); }
function addRobotC(){ robots.push(createRobotC()); }
function resetSim(){ robots = []; }

// --- Mouvements API ---
window.robot_api = {
  move(id, dist){
    const r = robots[id];
    if(!r) return;
    r.x += Math.cos(r.angle) * dist;
    r.y += Math.sin(r.angle) * dist;
  },
  turn(id, deg){
    const r = robots[id];
    if(!r) return;
    r.angle += deg * Math.PI/180;
  }
};

// --- Dessin ---
function drawRobot(r){
  ctx.save();
  ctx.translate(r.x, r.y);
  ctx.rotate(r.angle);

  ctx.fillStyle = r.color;
  ctx.fillRect(-r.size/2, -r.size/2, r.size, r.size);

  ctx.restore();
}

// --- Boucle render ---
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  robots.forEach(drawRobot);
  requestAnimationFrame(loop);
}
loop();


// =======================
//     BLOCKLY
// =======================

// Toolbox (blocs)
const toolbox = {
  "kind":"flyoutToolbox",
  "contents":[
    {
      "kind":"block",
      "type":"move_forward"
    },
    {
      "kind":"block",
      "type":"turn_right"
    }
  ]
};

// Injection
const workspace = Blockly.inject('blocklyDiv', {toolbox: toolbox});

// --- Blocs ---
// Avancer
Blockly.Blocks['move_forward'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("avancer de")
      .appendField(new Blockly.FieldNumber(50, 1, 500), "DIST")
      .appendField("px");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(120);
  }
};

Blockly.JavaScript['move_forward'] = function(block){
  const dist = block.getFieldValue('DIST');
  return `robot_api.move(0, ${dist});\n`;
};

// Tourner
Blockly.Blocks['turn_right'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("tourner de")
      .appendField(new Blockly.FieldAngle(90), "ANGLE");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(230);
  }
};

Blockly.JavaScript['turn_right'] = function(block){
  const deg = block.getFieldValue('ANGLE');
  return `robot_api.turn(0, ${deg});\n`;
};

// Bouton exécuter
document.getElementById("runBtn").onclick = () => {
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  const AsyncFn = Object.getPrototypeOf(async function(){}).constructor;
  const fn = new AsyncFn("robot_api", code);
  fn(robot_api);
};

</script>
</body>
</html>